### 1. запускамем docker 
### 2. в файле etc\hosts (C:\Windows\System32\drivers\etc\hosts на windows)  прописывем:
```
127.0.0.1       mongo1
127.0.0.1       mongo2
127.0.0.1       mongo3
```
### 3. переходим в дриректорию с docker-compose файлом с mongo прописываем:
```
docker-compose build
docker-compose up
```

поднимается 3 серевера на портах 30001, 30002, 30003 локально и в контейнерах. 

### 4. Доступ к каждому из серверов через mongosh:
```
docker exec -it mongo1 sh -c "mongo --port 30001"
docker exec -it mongo2 sh -c "mongo --port 30002"
docker exec -it mongo3 sh -c "mongo --port 30003"
```
```
winpty docker exec -it mongo1 sh -c "mongo --port 30001" //для windwos добавить winpty 
```
### 5. Для подключения к кластеру uri:
# ```mongodb://mongo1:30001,mongo2:30002,mongo3:30003/?replicaSet=my-replica-set ```
Например через mongo shell: 

```mongosh mongodb://mongo1:30001,mongo2:30002,mongo3:30003/?replicaSet=my-replica-set ```
Записываем тестовую строку: 
```
use GameShop
db.Info.insertOne({name: "Vasya", email: "vasya.sobaka.mail.ru"}) 
db.Info.find()
```

### 6. Или через Питон:
```
from pymongo import MongoClient
import pandas as pd
client = MongoClient('mongodb://mongo1:30001,mongo2:30002,mongo3:30003/?replicaSet=my-replica-set') 
df = pd.read_csv('test_data.csv')
db = client['GameShop']
collection = db['Info']
collection.insert_many(df.to_dict('records'))
```

### 7. Ресурсы контейнера 
Озу и CPU  

![image](https://github.com/levs2001/lr-game-shop/assets/86722732/0efecbea-aa7b-46bc-8680-31fc124a8e87)

Память диска задаем в size.  
volumes:  
  - ./data/mongo-1:/data/db,size=100m


### 8. Фактор репликации

Для увеличения фактора репликации MongoDB необходимо добавить новый узел в реплика-сет. Еть три узла (mongo1, mongo2, mongo3), монжно увеличить фактор репликации до 4 или более, добавив новые узлы.

Например добавить новый узел (mongo4) в реплика-сет:

Добавить файл docker-compose:
```
mongo4:
    image: mongo:5
    container_name: mongo4
    command: ["--replSet", "my-replica-set", "--bind_ip_all", "--port", "30004"]
    volumes:
      - ./data/mongo-4:/data/db,size=100m
    ports:
      - 30004:30004
    deploy:
      resources:
        limits:
          memory: 512m
          cpus: '1'
        reservations:
          memory: 256m
          cpus: '0.5'
```

Добавить инициализацию {_id:3,host:\"mongo4:30004\"}, в
```
 healthcheck:
      test: test $$(echo "rs.initiate({_id:'my-replica-set',members:[{_id:0,host:\"mongo1:30001\"},{_id:1,host:\"mongo2:30002\"},{_id:2,host:\"mongo3:30003\"}, {_id:3,host:\"mongo4:30004\"},]}).ok || rs.status().ok" | mongo --port 30001 --quiet) -eq 1
```

### 9. Проверка репликации 
```
mongosh --port 30001  #нужно конектится к primary не всегда это 30001

# тестовая запись 
use test_db
db.test_collection.insertOne({"test_field": "test_value"})

mongo --port 30002 # подкл к secondary

#проверка тестовой записи
use test_db
db.test_collection.find()
```

Вариант из пункта 5 тоже подходит для проверки, просто нужно выключить primary node и убедиться, что все работет после этого.   


# replica set
Реплика-сет (replica set) в MongoDB представляет собой группу узлов (серверов), которые хранят копии одной и той же базы данных. Реплика-сет обеспечивает отказоустойчивость и масштабируемость системы, позволяя автоматически восстанавливать работу базы данных в случае сбоя одного из узлов.

Каждый узел в реплика-сете может иметь одну из следующих ролей:

Первичный узел (primary node) - это узел, который принимает все записи в базу данных. Первичный узел подтверждает записи и реплицирует их во вторичные узлы. В любой момент времени в реплика-сете может быть только один первичный узел.  
Вторичный узел (secondary node) - это узел, который копирует данные из первичного узла. Вторичные узлы могут использоваться для чтения данных, но они не могут принимать записи. В реплика-сете может быть несколько вторичных узлов.  
Арбитр (arbiter) - это специальный узел, который не хранит данных, а только участвует в выборах первичного узла. Арбитр используется для предотвращения ситуации, когда в реплика-сете оказывается два первичных узла.
Репликация данных в MongoDB осуществляется путем копирования оперций записи (operations) из журнала операций (oplog) первичного узла во вторичные узлы. Журнал операций представляет собой специальную коллекцию, которая хранит все операции записи, выполненные на первичном узле.   

Когда первичный узел получает новую запись, он записывает ее в журнал операций. Затем вторичные узлы копируют операции из журнала операций первичного узла и применяют их к своим копиям базы данных. Таким образом, все вторичные узлы содержат те же данные, что и первичный узел.

В случае сбоя первичного узла, один из вторичных узлов автоматически избирается новым первичным узлом. Выборы первичного узла происходят путем голосования между узлами реплика-сета. Узел, получивший большинство голосов, становится новым первичным узлом. После избрания нового первичного узла, все вторичные узлы начинают копировать данные из нового первичного узла.

Реплика-сет в MongoDB позволяет обеспечить высокую доступность и отказоустойчивость системы, а также масштабировать ее за счет горизонтального расширения.
